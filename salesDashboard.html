<template>
    <div class="dashboard-container slds-var-p-around_small">
        <!-- 메인 헤더 -->
        <div class="header">
            <h1 class="main-title">영업사원 KPI</h1>
        </div>

        <!-- 로딩 스피너 -->
        <template if:true={isLoading}>
            <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
        </template>

        <template if:false={isLoading}>
            <!-- 1. 기본 대시보드 화면 -->
            <template if:false={selectedStage}>
                <!-- 목표 달성 현황 섹션 -->
                <div class="slds-m-bottom_large">
                    <div class="section-title-container">
                        <h2 class="section-title">이번 달 목표 달성 현황</h2>
                        <p class="section-subtitle">(건수 기준)</p>
                    </div>
                    <div class="goal-card">
                        <div class="goal-progress-circle" style={goalCircleStyle}>
                            <span class="goal-percentage">{formattedAchievementRate}%</span>
                        </div>
                        <div class="goal-details">
                            <p class="goal-text">목표 {goalCount}건 / 달성 {actualCount}건</p>
                        </div>
                    </div>
                </div>

                <!-- 단계별 기회 현황 섹션 -->
                <div>
                    <div class="section-title-container">
                        <h2 class="section-title">단계별 기회 현황</h2>
                    </div>
                    <template for:each={funnelData} for:item="step">
                        <div key={step.stageName} class="funnel-step-card" data-stage={step.stageName} onclick={handleStageClick}>
                            <div class="stage-info">
                                <span class="stage-name">{step.stageName}</span>
                                <span class="opp-count">{step.oppCount} 건</span>
                            </div>
                            <!-- [수정] if:true 조건을 새로운 boolean 속성으로 변경 -->
                            <template if:true={step.hasConversionRate}>
                                <div class="conversion-info">
                                    <lightning-icon icon-name="utility:arrow_right" size="x-small" class="arrow-icon"></lightning-icon>
                                    <span class="conversion-rate">{step.formattedConversionRate}% 전환</span>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </template>

            <!-- 2. 기회 목록 화면 -->
            <template if:true={selectedStage}>
                <div class="opportunity-list-container">
                    <!-- 뒤로가기 버튼과 제목 -->
                    <div class="list-header">
                        <button class="back-button" onclick={handleBackClick}>
                            <lightning-icon icon-name="utility:chevronleft" size="small" class="back-icon"></lightning-icon>
                            뒤로
                        </button>
                        <h2 class="section-title">{selectedStage} 단계의 기회 목록</h2>
                    </div>

                    <!-- 기회 목록 데이터 테이블 -->
                    <template if:true={opportunities}>
                        <lightning-datatable
                            key-field="Id"
                            data={opportunities}
                            columns={opportunityColumns}
                            hide-checkbox-column="true"
                            show-row-number-column="false">
                        </lightning-datatable>
                    </template>

                    <!-- 목록 로딩 중 스피너 -->
                    <template if:true={isOppLoading}>
                        <lightning-spinner alternative-text="Loading Opportunities" size="medium"></lightning-spinner>
                    </template>

                     <!-- 데이터가 없을 경우 메시지 -->
                    <template if:false={isOppLoading}>
                        <template if:false={hasOpportunities}>
                             <div class="slds-text-align_center slds-var-p-around_medium">
                                 이 단계에는 표시할 기회가 없습니다.
                             </div>
                        </template>
                    </template>
                </div>
            </template>
        </template>
    </div>
</template>
